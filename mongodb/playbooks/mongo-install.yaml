---
# Need to run 'ansible-galaxy collection install ansible.posix'
# and ansible-galaxy collection install kubernetes.core before using
- hosts: all
  become: true
  tasks:
  - name: Add MongoDB yum repository
    yum_repository:
      name: MongoDB Repository
      baseurl: https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/6.0/x86_64/
      gpgcheck: 1
      enabled: 1
      gpgkey: https://www.mongodb.org/static/pgp/server-6.0.asc

  - name: Install mongodb packages
    yum:
      name:
      - mongodb-org-6.0.4
      - mongodb-org-database-6.0.4
      - mongodb-org-server-6.0.4
      - mongodb-org-mongos-6.0.4
      - mongodb-org-tools-6.0.4
      state: present

  - name: Pin Mongo packages to fix db version
    lineinfile:
      path: /etc/yum.conf
      line: mongodb-org-6.0.4 mongodb-org-database-6.0.4 mongodb-org-server-6.0.4 mongodb-org-mongos-6.0.4 mongodb-org-tools-6.0.4

  # Not necessary once upgraded to CentOS>=8
  - name: Specify a nproc max process limitation [CentOS7]
    blockinfile:
      create: true
      path: /etc/security/limits.d/20-nproc.conf
      block: |
        * soft nproc 4096
        * hard nproc 4096

  - name: Specify recommended ulimit settings
    blockinfile:
      path: /etc/systemd/system/mongod.service
      block: |
        [Service]
        # Other directives omitted
        # (file size)
        LimitFSIZE=infinity
        # (cpu time)
        LimitCPU=infinity
        # (virtual memory size)
        LimitAS=infinity
        # (locked-in-memory size)
        LimitMEMLOCK=infinity
        # (open files)
        LimitNOFILE=64000
        # (processes/threads)
        LimitNPROC=64000

  - name: Ensure packages needed for configuring SELinux are available
    yum:
      name:
      - git
      - make
      - checkpolicy
      - policycoreutils
      - selinux-policy-devel
      state: present

  - name: Clone mongodb-selinux repository
    git:
      repo: 'https://github.com/mongodb/mongodb-selinux'
      dest: /home/vagrant
